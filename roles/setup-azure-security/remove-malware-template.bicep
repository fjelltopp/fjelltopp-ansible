param defender_logic_app_malware_removal_name string = 'LOGICAPP-Remove-MalwareBlob'
param storage_account_name string
param location string = resourceGroup().location

resource defender_logic_app_malware_removal_name_resource 'Microsoft.Logic/workflows@2019-05-01' = {
  name: defender_logic_app_malware_removal_name
  location: location
  tags: {
    LogicAppsCategory: 'security'
  }
  identity: {
    type: 'SystemAssigned'
  }
  properties: {
    state: 'Enabled'
    definition: {
      '$schema': 'https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#'
      contentVersion: '1.0.0.0'
      parameters: {
        '$connections': {
          defaultValue: {}
          type: 'Object'
        }
      }
      actions: {
        Condition: {
          actions: {
            GetBlobEntity: {
              type: 'Query'
              inputs: {
                from: '@triggerBody()?[\'Entities\']'
                where: '@equals(item().type, \'blob\')'
              }
            }
            Delete_Blob: {
              runAfter: {
                GetBlobEntity: [
                  'Succeeded'
                ]
              }
              type: 'Http'
              inputs: {
                uri: '@{body(\'GetBlobEntity\')[0].Url}'
                method: 'DELETE'
                headers: {
                  'x-ms-version': '2019-07-07'
                }
                authentication: {
                  audience: 'https://@{triggerBody()?[\'CompromisedEntity\']}.blob.core.windows.net/'
                  type: 'ManagedServiceIdentity'
                }
              }
            }
          }
          runAfter: {}
          else: {
            actions: {}
          }
          expression: {
            and: [
              {
                equals: [
                  '@triggerBody()?[\'CompromisedEntity\']'
                  storage_account_name
                ]
              }
            ]
          }
          type: 'If'
        }
      }
      outputs: {}
    }
    parameters: {}
  }
}
